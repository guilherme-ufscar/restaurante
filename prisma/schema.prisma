// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  USER
  RESTAURANT
  ADMIN
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PlanInterval {
  MONTHLY
  QUARTERLY
  SEMIANNUAL
  ANNUAL
}

enum DeliveryType {
  DELIVERY
  PICKUP
}

enum PaymentStatus {
  PENDING
  PAID
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  DELIVERING
  COMPLETED
  CANCELLED
}

// Models
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts   Account[]
  sessions   Session[]
  addresses  Address[]
  orders     Order[]
  restaurant Restaurant?
  reviews    Review[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Address {
  id           String   @id @default(cuid())
  userId       String
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String
  zipCode      String
  latitude     Decimal? @db.Decimal(10, 8)
  longitude    Decimal? @db.Decimal(11, 8)
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  image       String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  restaurants Restaurant[]
}

model Restaurant {
  id                     String             @id @default(cuid())
  name                   String
  slug                   String             @unique
  description            String?            @db.Text
  logo                   String?
  banner                 String?
  email                  String
  phone                  String
  ownerId                String             @unique
  categoryId             String
  minOrderValue          Decimal            @db.Decimal(10, 2)
  deliveryFee            Decimal            @db.Decimal(10, 2)
  estimatedDeliveryTime  Int
  isActive               Boolean            @default(false)
  isApproved             Boolean            @default(false)
  approvedAt             DateTime?
  rejectedAt             DateTime?
  rejectionReason        String?            @db.Text
  subscriptionStatus     SubscriptionStatus @default(PENDING)
  subscriptionPlanId     String?
  subscriptionExpiresAt  DateTime?
  rating                 Decimal?           @db.Decimal(3, 2)
  totalReviews           Int                @default(0)
  opensAt                String
  closesAt               String
  acceptsPickup          Boolean            @default(true)
  acceptsDelivery        Boolean            @default(true)
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  owner          User                       @relation(fields: [ownerId], references: [id])
  category       Category                   @relation(fields: [categoryId], references: [id])
  subscriptionPlan SubscriptionPlan?        @relation(fields: [subscriptionPlanId], references: [id])
  products       Product[]
  orders         Order[]
  paymentMethods RestaurantPaymentMethod[]
  reviews        Review[]
}

model SubscriptionPlan {
  id          String       @id @default(cuid())
  name        String
  description String?      @db.Text
  price       Decimal      @db.Decimal(10, 2)
  interval    PlanInterval
  features    String[]     @db.Text
  maxProducts Int?
  maxOrders   Int?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  restaurants Restaurant[]
}

model Product {
  id              String   @id @default(cuid())
  restaurantId    String
  name            String
  description     String?  @db.Text
  image           String?
  price           Decimal  @db.Decimal(10, 2)
  discountPrice   Decimal? @db.Decimal(10, 2)
  category        String
  isAvailable     Boolean  @default(true)
  preparationTime Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  restaurant Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]
}

model PaymentMethod {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  restaurants RestaurantPaymentMethod[]
}

model RestaurantPaymentMethod {
  id              String  @id @default(cuid())
  restaurantId    String
  paymentMethodId String
  isActive        Boolean @default(true)

  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  paymentMethod PaymentMethod @relation(fields: [paymentMethodId], references: [id])

  @@unique([restaurantId, paymentMethodId])
}

model Order {
  id                    String        @id @default(cuid())
  orderNumber           String        @unique
  userId                String
  restaurantId          String
  totalAmount           Decimal       @db.Decimal(10, 2)
  deliveryFee           Decimal       @db.Decimal(10, 2)
  discount              Decimal?      @db.Decimal(10, 2)
  finalAmount           Decimal       @db.Decimal(10, 2)
  deliveryType          DeliveryType
  paymentMethodId       String
  paymentStatus         PaymentStatus
  status                OrderStatus   @default(PENDING)
  addressId             String?
  deliveryAddress       String?       @db.Text
  estimatedDeliveryTime DateTime?
  notes                 String?       @db.Text
  cancelReason          String?       @db.Text
  cancelledAt           DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  user       User        @relation(fields: [userId], references: [id])
  restaurant Restaurant  @relation(fields: [restaurantId], references: [id])
  address    Address?    @relation(fields: [addressId], references: [id])
  items      OrderItem[]
  review     Review?
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  productId  String
  quantity   Int
  unitPrice  Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)
  notes      String?

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

model Review {
  id           String   @id @default(cuid())
  orderId      String   @unique
  userId       String
  restaurantId String
  rating       Int
  comment      String?  @db.Text
  createdAt    DateTime @default(now())

  order      Order      @relation(fields: [orderId], references: [id])
  user       User       @relation(fields: [userId], references: [id])
  restaurant Restaurant @relation(fields: [restaurantId], references: [id])
}
